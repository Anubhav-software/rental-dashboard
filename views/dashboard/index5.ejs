<div class="row gy-4">

    <% if (typeof stats !== 'undefined' && stats) { %>
    <!-- Stats: Revenue, Expenses, Profit, Active Rentals -->
    <div class="col-xxl-3 col-sm-6">
        <div class="card px-24 py-16 shadow-none radius-8 border h-100 bg-gradient-start-4">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center">
                        <div class="w-64-px h-64-px radius-16 bg-base-50 d-flex justify-content-center align-items-center me-20">
                            <span class="mb-0 w-40-px h-40-px bg-success-main flex-shrink-0 text-white d-flex justify-content-center align-items-center radius-8 h6 mb-0">
                                <iconify-icon icon="streamline:bag-dollar-solid" class="icon"></iconify-icon>
                            </span>
                        </div>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-md">Revenue (this month)</span>
                            <h6 class="fw-semibold my-1" id="dashboard-kpi-revenue">₹<%= stats.revenue %></h6>
                            <p class="text-sm mb-0"><a href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/reports/revenue" class="text-primary-light text-decoration-none">View report</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-sm-6">
        <div class="card px-24 py-16 shadow-none radius-8 border h-100 bg-gradient-start-5">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center">
                        <div class="w-64-px h-64-px radius-16 bg-base-50 d-flex justify-content-center align-items-center me-20">
                            <span class="mb-0 w-40-px h-40-px bg-red flex-shrink-0 text-white d-flex justify-content-center align-items-center radius-8 h6 mb-0">
                                <iconify-icon icon="fa6-solid:file-invoice-dollar" class="text-white text-2xl mb-0"></iconify-icon>
                            </span>
                        </div>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-md">Expenses (this month)</span>
                            <h6 class="fw-semibold my-1" id="dashboard-kpi-expenses">₹<%= stats.expenses %></h6>
                            <p class="text-sm mb-0"><a href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/reports/expense" class="text-primary-light text-decoration-none">View report</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-sm-6">
        <div class="card px-24 py-16 shadow-none radius-8 border h-100 bg-gradient-start-3">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center">
                        <div class="w-64-px h-64-px radius-16 bg-base-50 d-flex justify-content-center align-items-center me-20">
                            <span class="mb-0 w-40-px h-40-px bg-primary-600 flex-shrink-0 text-white d-flex justify-content-center align-items-center radius-8 h6 mb-0">
                                <iconify-icon icon="mdi:chart-areaspline" class="icon"></iconify-icon>
                            </span>
                        </div>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-md">Profit (this month)</span>
                            <h6 class="fw-semibold my-1 <%= stats.profit >= 0 ? 'text-success-600' : 'text-danger-600' %>" id="dashboard-kpi-profit">₹<%= stats.profit %></h6>
                            <p class="text-sm mb-0"><a href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/reports/profit" class="text-primary-light text-decoration-none">View report</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-sm-6">
        <div class="card px-24 py-16 shadow-none radius-8 border h-100 bg-gradient-start-2">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center">
                        <div class="w-64-px h-64-px radius-16 bg-base-50 d-flex justify-content-center align-items-center me-20">
                            <span class="mb-0 w-40-px h-40-px bg-purple flex-shrink-0 text-white d-flex justify-content-center align-items-center radius-8 h6 mb-0">
                                <iconify-icon icon="mdi:car-outline" class="text-white text-2xl mb-0"></iconify-icon>
                            </span>
                        </div>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-md">Active Rentals</span>
                            <h6 class="fw-semibold my-1" id="dashboard-kpi-active-rentals"><%= stats.activeRentals %></h6>
                            <p class="text-sm mb-0"><a href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/rental/active" class="text-primary-light text-decoration-none">Process return</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- What's due today (client requirement: daily due list) -->
    <div class="col-12">
        <div class="card radius-12 border overflow-hidden">
            <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center justify-content-between">
                <h6 class="mb-0 fw-semibold text-primary-light d-flex align-items-center gap-2">
                    <iconify-icon icon="mdi:calendar-clock-outline" class="text-primary-600"></iconify-icon>
                    What's due today
                </h6>
                <a href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/vehicle/due" class="btn btn-sm btn-outline-primary radius-8">View all due</a>
            </div>
            <div class="card-body p-24">
                <% if (typeof dueListToday !== 'undefined' && dueListToday && dueListToday.length > 0) { %>
                <div class="table-responsive scroll-sm">
                    <table class="table bordered-table sm-table mb-0">
                        <thead>
                            <tr>
                                <th scope="col">Vehicle</th>
                                <th scope="col">Due type</th>
                                <th scope="col">Due date</th>
                                <th scope="col" class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% (dueListToday.slice(0, 7)).forEach(function(item) { %>
                            <tr>
                                <td><span class="fw-medium text-primary-light"><%= item.vehicle.make %> <%= item.vehicle.model %></span> <span class="text-secondary-light text-sm">(<%= item.vehicle.registrationNumber %>)</span></td>
                                <td><span class="badge bg-warning-focus text-warning-600"><%= item.dueType %></span></td>
                                <td><span class="text-primary-light"><%= item.dueDate %></span></td>
                                <td class="text-center"><a href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/vehicle/view/<%= item.vehicle.id %>" class="btn btn-sm btn-outline-primary radius-8">View</a></td>
                            </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
                <% } else { %>
                <p class="text-secondary-light mb-0">No items due today. Add due dates (tax, battery, service, oil) in vehicle add/edit.</p>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Recent Rentals (filled by JS from API) -->
    <div class="col-12">
        <div class="card radius-12 border overflow-hidden" data-base-path="<%= typeof basePath !== 'undefined' ? basePath : '' %>">
            <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center justify-content-between">
                <h6 class="mb-0 fw-semibold text-primary-light d-flex align-items-center gap-2">
                    <iconify-icon icon="mdi:file-document-outline" class="text-primary-600"></iconify-icon>
                    Recent Rentals
                </h6>
                <a href="<%= typeof basePath !== 'undefined' ? basePath : '' %>/rental" class="btn btn-sm btn-outline-primary radius-8">View all</a>
            </div>
            <div class="card-body p-24">
                <div class="table-responsive scroll-sm">
                    <table class="table bordered-table sm-table mb-0">
                        <thead>
                            <tr>
                                <th scope="col">Contract</th>
                                <th scope="col">Customer</th>
                                <th scope="col">Vehicle</th>
                                <th scope="col">Start — End</th>
                                <th scope="col">Amount</th>
                                <th scope="col">Status</th>
                                <th scope="col" class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-recent-rentals-tbody">
                            <tr>
                                <td colspan="7" class="text-center text-secondary-light py-24">Loading…</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <% } else { %>
    <!-- Fallback static widgets when stats not passed -->
    <div class="col-xxl-3 col-sm-6">
        <div class="card px-24 py-16 shadow-none radius-8 border h-100 bg-gradient-start-3">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center">
                        <div class="w-64-px h-64-px radius-16 bg-base-50 d-flex justify-content-center align-items-center me-20">
                            <span class="mb-0 w-40-px h-40-px bg-primary-600 flex-shrink-0 text-white d-flex justify-content-center align-items-center radius-8 h6 mb-0">
                                <iconify-icon icon="flowbite:users-group-solid" class="icon"></iconify-icon>
                            </span>
                        </div>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-md">New Users</span>
                            <h6 class="fw-semibold my-1">5000</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-sm-6">
        <div class="card px-24 py-16 shadow-none radius-8 border h-100 bg-gradient-start-2">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center">
                        <div class="w-64-px h-64-px radius-16 bg-base-50 d-flex justify-content-center align-items-center me-20">
                            <span class="mb-0 w-40-px h-40-px bg-purple flex-shrink-0 text-white d-flex justify-content-center align-items-center radius-8 h6 mb-0">
                                <iconify-icon icon="solar:wallet-bold" class="text-white text-2xl mb-0"></iconify-icon>
                            </span>
                        </div>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-md">Total Deposit</span>
                            <h6 class="fw-semibold my-1">15,000</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-sm-6">
        <div class="card px-24 py-16 shadow-none radius-8 border h-100 bg-gradient-start-5">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center">
                        <div class="w-64-px h-64-px radius-16 bg-base-50 d-flex justify-content-center align-items-center me-20">
                            <span class="mb-0 w-40-px h-40-px bg-red flex-shrink-0 text-white d-flex justify-content-center align-items-center radius-8 h6 mb-0">
                                <iconify-icon icon="fa6-solid:file-invoice-dollar" class="text-white text-2xl mb-0"></iconify-icon>
                            </span>
                        </div>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-md">Total Expense</span>
                            <h6 class="fw-semibold my-1">15,000</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xxl-3 col-sm-6">
        <div class="card px-24 py-16 shadow-none radius-8 border h-100 bg-gradient-start-4">
            <div class="card-body p-0">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                    <div class="d-flex align-items-center">
                        <div class="w-64-px h-64-px radius-16 bg-base-50 d-flex justify-content-center align-items-center me-20">
                            <span class="mb-0 w-40-px h-40-px bg-success-main flex-shrink-0 text-white d-flex justify-content-center align-items-center radius-8 h6 mb-0">
                                <iconify-icon icon="streamline:bag-dollar-solid" class="icon"></iconify-icon>
                            </span>
                        </div>
                        <div>
                            <span class="mb-2 fw-medium text-secondary-light text-md">Total Earning</span>
                            <h6 class="fw-semibold my-1">15,000</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <% } %>
    <!-- Profit by month (this year) Start -->
    <div class="col-xxl-8">
        <div class="card h-100 radius-8 border-0">
            <div class="card-body p-24">
                <div class="d-flex align-items-center flex-wrap gap-2 justify-content-between">
                    <div>
                        <h6 class="mb-2 fw-bold text-lg">Profit by month</h6>
                        <span class="text-sm fw-medium text-secondary-light">Net profit per month</span>
                    </div>
                    <div>
                        <select id="dashboard-profit-year" class="form-select form-select-sm w-auto bg-base border text-secondary-light" aria-label="Year">
                            <!-- Options filled by JS -->
                        </select>
                    </div>
                </div>
                <div id="profitByMonthChart" class="mt-24"></div>
            </div>
        </div>
    </div>
    <!-- Profit by month End -->
    <!-- Top customers (this month) -->
    <div class="col-xxl-4">
        <div class="card h-100 radius-8 border-0">
            <div class="card-body p-24">
                <h6 class="mb-2 fw-bold text-lg">Top customers</h6>
                <span class="text-sm fw-medium text-secondary-light">By revenue this month</span>
                <div id="dashboard-top-customers" class="mt-16">
                    <p class="text-secondary-light text-sm mb-0">Loading…</p>
                </div>
            </div>
        </div>
    </div>

</div>

<% script = `<script src='/js/api/analyticsApi.js'></script><script src='/js/api/rentalApi.js'></script><script src='/js/pages/dashboard-index5.js'></script><script src='/js/pages/dashboard-profit-chart.js'></script><script src='/js/pages/dashboard-top-customers.js'></script>` %>